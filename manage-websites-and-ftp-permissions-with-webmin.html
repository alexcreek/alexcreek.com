<!DOCTYPE html>
<html lang="en">
<head>
          <title>Stuff I Wanna Remember</title>
        <meta charset="utf-8" />
        <link href="alexcreek.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Stuff I Wanna Remember Full Atom Feed" />
        <link href="alexcreek.com/feeds/system-administration.atom.xml" type="application/atom+xml" rel="alternate" title="Stuff I Wanna Remember Categories Atom Feed" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="../../favicon.ico">





    <!-- Google web fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,900' rel='stylesheet' type='text/css'>

    <!-- Bootstrap core CSS -->
    <link href="./theme/css/bootstrap.min.css" rel="stylesheet"> 

    <!-- Custom styles for this template -->
    <link href="./theme/css/starter-template.css" rel="stylesheet"> 
    
    <!-- Search CSS -->
    <link rel="stylesheet" href="./theme/tipuesearch/tipuesearch.css"> 
</head>

 <body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="./category/code.html">Code</a></li>
                    <li><a href="./category/networking.html">Networking</a></li>
                    <li class="active"><a href="./category/system-administration.html">System Administration</a></li>
          </ul>
<!--                <form id="searchform" action="/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
                    <div class="form-group">
                        <input class="form-control" id="searchbox" type="text" name="q" size="12" placeholder="Search">
                    </div>
                </form> -->
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
<body id="index" class="home">
        <header id="banner" class="body">
                <h1 class="header"><a href="./">Stuff I Wanna Remember <strong></strong></a></h1>
        </header><!-- /#banner -->

<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="./manage-websites-and-ftp-permissions-with-webmin.html" rel="bookmark"
         title="Permalink to Manage websites and FTP permissions with Webmin">Manage websites and FTP permissions with Webmin</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2014-10-28T00:00:00-04:00">
      Tue 28 October 2014
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="./author/alex.html">alex</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>So the question at hand is, how can we setup Webmin to create websites and have an ftp user that can manage the sites with minimal overhead? 
This can be done in 3 steps:</p>
<h3>1) Create an ftp user, make their home directory the toplevel directory of the default DocumentRoot and add them to the apache group.</h3>
<p><code>adduser uploader --home=/var/www --shell=/sbin/nologin --gid=apache</code>  </p>
<h3>2) Change the permissions of DocumentRoot directories that Webmin creates to group writeable</h3>
<p>This requires modifying Webmin's core files.  Aside from the obvious threat of breaking Webmin, the not so obvious danger is that if Webmin is updated then the modifications may be lost. So it's important to take notes of what's been done. </p>
<p>The file that controls creating apache virtualhosts is <code>/usr/libexec/webmin/apache/create_virt.cgi</code>.  There aren't any functions in the file, so we're looking for a comment to locate what we need, <code># Check if the root directory is allowed</code>.</p>
<div class="highlight"><pre><span class="err">#</span><span class="x"> Check if the root directory is allowed</span>
<span class="x">!</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;} || &amp;allowed_auth_file(</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}) ||</span>
<span class="x">        &amp;error(&amp;text(&#39;cvirt_eroot3&#39;, </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}));</span>

<span class="x">if (</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;} &amp;&amp; !-d </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}) </span><span class="err">{</span><span class="x"></span>
<span class="x">        </span><span class="err">#</span><span class="x"> create the document root</span>
<span class="x">        mkdir(</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}, 0755) ||</span>
<span class="x">                &amp;error(&amp;text(&#39;cvirt_eroot2&#39;, </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}, </span><span class="p">$</span><span class="x">!));</span>
<span class="x">        </span><span class="p">$</span><span class="nv">user</span><span class="x"> = &amp;find_directive(&quot;User&quot;, </span><span class="p">$</span><span class="nv">conf</span><span class="x">);</span>
<span class="x">        </span><span class="p">$</span><span class="nv">group</span><span class="x"> = &amp;find_directive(&quot;Group&quot;, </span><span class="p">$</span><span class="nv">conf</span><span class="x">);</span>
<span class="x">        </span><span class="p">$</span><span class="nv">uid</span><span class="x"> = </span><span class="p">$</span><span class="nv">user</span><span class="x"> ? getpwnam(</span><span class="p">$</span><span class="nv">user</span><span class="x">) : 0;</span>
<span class="x">        </span><span class="p">$</span><span class="nv">gid</span><span class="x"> = </span><span class="p">$</span><span class="nv">group</span><span class="x"> ? getgrnam(</span><span class="p">$</span><span class="nv">group</span><span class="x">) : 0;</span>
<span class="x">        chown(</span><span class="p">$</span><span class="nv">uid</span><span class="x">, </span><span class="p">$</span><span class="nv">gid</span><span class="x">, </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;});</span>
<span class="x">        }</span>
</pre></div>


<p>To modify the DocumentRoot's, permissions add a call to chmod after the directory has been created.</p>
<p>Original:</p>
<div class="highlight"><pre><span class="x">if (</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;} &amp;&amp; !-d </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}) </span><span class="err">{</span><span class="x"></span>
<span class="x">        </span><span class="err">#</span><span class="x"> create the document root</span>
<span class="x">        mkdir(</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}, 0755) ||</span>
<span class="x">                &amp;error(&amp;text(&#39;cvirt_eroot2&#39;, </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}, </span><span class="p">$</span><span class="x">!));</span>
<span class="x">        </span><span class="p">$</span><span class="nv">user</span><span class="x"> = &amp;find_directive(&quot;User&quot;, </span><span class="p">$</span><span class="nv">conf</span><span class="x">);</span>
<span class="x">        </span><span class="p">$</span><span class="nv">group</span><span class="x"> = &amp;find_directive(&quot;Group&quot;, </span><span class="p">$</span><span class="nv">conf</span><span class="x">);</span>
</pre></div>


<p>Modified:</p>
<div class="highlight"><pre><span class="x">if (</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;} &amp;&amp; !-d </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}) </span><span class="err">{</span><span class="x"></span>
<span class="x">        </span><span class="err">#</span><span class="x"> create the document root</span>
<span class="x">        mkdir(</span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}, 0755) ||</span>
<span class="x">                &amp;error(&amp;text(&#39;cvirt_eroot2&#39;, </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;}, </span><span class="p">$</span><span class="x">!));</span>
<span class="x">        chmod 0775, </span><span class="p">$</span><span class="nv">in</span><span class="err">{</span><span class="x">&#39;root&#39;};</span>
<span class="x">        </span><span class="p">$</span><span class="nv">user</span><span class="x"> = &amp;find_directive(&quot;User&quot;, </span><span class="p">$</span><span class="nv">conf</span><span class="x">);</span>
<span class="x">        </span><span class="p">$</span><span class="nv">group</span><span class="x"> = &amp;find_directive(&quot;Group&quot;, </span><span class="p">$</span><span class="nv">conf</span><span class="x">);</span>
</pre></div>


<h3>3) The final step is to change the umask settings for the FTP server.  This will control the permissions of all newly created files and directories</h3>
<h4>vsftpd</h4>
<div class="highlight"><pre>vi /etc/vsftpd/vsftpd.conf
local_umask=002
</pre></div>


<h4>ProFTPD</h4>
<div class="highlight"><pre>vi /etc/proftpd.conf
Umask                           002
</pre></div>


<h3>4) Restart services</h3>
<div class="highlight"><pre>service proftpd restart
service webmin restart
</pre></div>


<p></br></p>
<p>These settings will allow a website to be bootstrapped using Webmin and FTP uploads, however it should be noted that having a site's DocumentRoot writable by the webserver process is considered a security vulnerability and should be evaluated for it's actual usefulness. </p>
  </div><!-- /.entry-content -->
</section>
    </div>

<script type="text/javascript">
    var disqus_shortname = 'alexcreekcom';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
        
        <footer id="contentinfo" class="container">
                <address id="about" class="vcard body">
                </br>Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
    
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-56063544-1");
pageTracker._trackPageview();
} catch(err) {}</script>

    
</body>
</html>
